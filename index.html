<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>门诊空间效能仿真系统 Pro+</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px 0 rgba(100, 100, 200, 0.15);
            --primary-purple: #8b5cf6;
        }

        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 50%, #ddd6fe 100%);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #334155;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.2s;
        }
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }

        .glass-btn {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            transition: all 0.2s;
        }
        .glass-btn:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: translateY(-1px);
        }
        .glass-btn:active {
            transform: translateY(0);
        }
        
        .active-view-btn {
            background: #8b5cf6;
            color: white;
            border-color: #7c3aed;
        }

        /* Canvas & Layout */
        .canvas-bg {
            background-image: 
                radial-gradient(rgba(139, 92, 246, 0.2) 1px, transparent 1px),
                radial-gradient(rgba(139, 92, 246, 0.1) 1px, transparent 1px);
            background-size: 20px 20px, 100px 100px;
            background-position: 0 0, 0 0;
        }

        /* Transitions */
        .panel-transition {
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(139, 92, 246, 0.6); }

        .collapsed-text {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            white-space: nowrap;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm">

    <!-- Header -->
    <header class="h-16 glass-panel z-50 flex items-center justify-between px-6 mx-4 mt-4 rounded-2xl relative">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-purple-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
            </div>
            <div>
                <h1 class="text-lg font-bold text-gray-800 tracking-tight">门诊空间效能仿真 Pro+</h1>
                <p class="text-[10px] text-gray-500 font-medium">Outpatient Space Efficiency & Layout Generator</p>
            </div>
        </div>

        <!-- Simulation Controls -->
        <div class="absolute left-1/2 transform -translate-x-1/2 flex items-center gap-2 bg-white/40 p-1.5 rounded-xl border border-white/50 backdrop-blur-md shadow-sm">
            <button onclick="toggleSimulation()" id="btnPlayPause" class="w-10 h-10 flex items-center justify-center rounded-lg bg-white shadow-sm text-purple-600 hover:text-purple-700 hover:bg-purple-50 transition-colors">
                <svg id="iconPlay" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                <svg id="iconPause" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
            </button>
            <div class="h-6 w-px bg-gray-300 mx-1"></div>
            <button onclick="changeSpeed(1)" class="px-3 py-1.5 text-xs font-bold rounded-lg bg-purple-100 text-purple-700 transition" id="speed1">x1</button>
            <button onclick="changeSpeed(10)" class="px-3 py-1.5 text-xs font-semibold rounded-lg hover:bg-white/50 text-gray-600 transition" id="speed10">x10</button>
            <div class="h-6 w-px bg-gray-300 mx-1"></div>
            <div class="px-3 text-xs font-mono text-purple-800" id="simTimeDisplay">00:00</div>
        </div>

        <div class="flex gap-2">
             <button onclick="switchView('layout')" id="btnViewLayout" class="glass-btn active-view-btn px-3 py-2 rounded-lg text-xs font-semibold flex items-center gap-1 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" /></svg>
                平面仿真
            </button>
            <button onclick="switchView('graph')" id="btnViewGraph" class="glass-btn px-3 py-2 rounded-lg text-xs font-semibold text-gray-600 flex items-center gap-1 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" /></svg>
                时空图谱
            </button>
            <button onclick="resetSimulation()" class="glass-btn px-3 py-2 rounded-lg text-xs font-semibold text-gray-600 flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                重置
            </button>
        </div>
    </header>

    <!-- Main Body -->
    <main class="flex-1 flex overflow-hidden p-4 gap-4 relative">

        <!-- Left Panel: Parameters -->
        <div id="leftPanel" class="w-80 glass-panel rounded-2xl flex flex-col panel-transition relative z-20">
            <button onclick="togglePanel('left')" class="absolute -right-3 top-1/2 transform -translate-y-1/2 w-6 h-12 bg-white rounded-full shadow-md flex items-center justify-center border border-gray-100 cursor-pointer hover:bg-purple-50 z-30 group">
                <svg id="leftToggleIcon" xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-500 group-hover:text-purple-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
            </button>
            
            <div class="p-5 border-b border-white/40 flex-shrink-0 panel-content">
                <h2 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                    <span class="w-1.5 h-4 bg-purple-500 rounded-full"></span> 
                    参数配置
                </h2>
            </div>
            
            <div class="overflow-y-auto flex-1 p-5 space-y-6 panel-content">
                <!-- Group 1: Flow -->
                <div class="bg-white/40 p-4 rounded-xl border border-white/50">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-3 flex items-center gap-2">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                        流量与资源
                    </h3>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-1">日门诊量</label>
                                <input type="number" id="dailyFlow" value="1500" class="w-full glass-input rounded-lg px-2 py-1.5 text-xs font-medium">
                            </div>
                             <div>
                                <label class="block text-[10px] text-gray-500 mb-1">复诊率(%)</label>
                                <input type="number" id="returnRate" value="30" class="w-full glass-input rounded-lg px-2 py-1.5 text-xs font-medium">
                            </div>
                        </div>
                        <hr class="border-white/40">
                        <div class="grid grid-cols-3 gap-2 text-[10px] text-gray-500">
                             <span></span><span>数量(个)</span><span>耗时(分)</span>
                        </div>
                        <div class="grid grid-cols-3 gap-2 items-center">
                            <label class="text-[10px] font-semibold">挂号</label>
                            <input type="number" id="res_reg" value="4" class="glass-input rounded px-1 py-1 text-xs">
                            <input type="number" id="time_reg" value="2" class="glass-input rounded px-1 py-1 text-xs">
                        </div>
                        <div class="grid grid-cols-3 gap-2 items-center">
                            <label class="text-[10px] font-semibold">诊室</label>
                            <input type="number" id="res_doc" value="15" class="glass-input rounded px-1 py-1 text-xs">
                            <input type="number" id="time_doc" value="10" class="glass-input rounded px-1 py-1 text-xs">
                        </div>
                        <div class="grid grid-cols-3 gap-2 items-center">
                            <label class="text-[10px] font-semibold">收费</label>
                            <input type="number" id="res_phar" value="4" class="glass-input rounded px-1 py-1 text-xs">
                            <input type="number" id="time_phar" value="3" class="glass-input rounded px-1 py-1 text-xs">
                        </div>
                    </div>
                </div>

                <!-- Group 2: Space & Distance -->
                <div class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100">
                    <h3 class="text-xs font-bold text-indigo-600 uppercase mb-3 flex items-center gap-2">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                        空间与路径 (输入)
                    </h3>
                    
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                             <div>
                                <label class="block text-[10px] text-indigo-500 mb-1">单诊室面积(m²)</label>
                                <input type="number" id="area_doc_unit" value="12" class="w-full bg-white/70 border border-indigo-200 rounded px-2 py-1 text-xs font-bold text-indigo-700">
                            </div>
                            <div>
                                <label class="block text-[10px] text-indigo-500 mb-1">单窗口面积(m²)</label>
                                <input type="number" id="area_win_unit" value="6" class="w-full bg-white/70 border border-indigo-200 rounded px-2 py-1 text-xs font-bold text-indigo-700">
                            </div>
                        </div>
                         <div>
                            <label class="block text-[10px] text-indigo-500 mb-1">主街/走廊宽度 (m) - GB51039</label>
                            <input type="number" id="width_corridor" value="3.0" class="w-full bg-white/70 border border-indigo-200 rounded px-2 py-1 text-xs font-bold text-indigo-700">
                        </div>

                        <div class="pt-2 border-t border-indigo-100">
                            <label class="block text-[10px] font-bold text-gray-500 mb-2">连接线长度 (m)</label>
                            <div class="space-y-1">
                                <div class="flex justify-between items-center text-[10px]">
                                    <span>入口 → 挂号</span>
                                    <input type="number" id="dist_1" value="15" class="w-16 text-right bg-white/50 border rounded px-1">
                                </div>
                                <div class="flex justify-between items-center text-[10px]">
                                    <span>挂号 → 候诊</span>
                                    <input type="number" id="dist_2" value="30" class="w-16 text-right bg-white/50 border rounded px-1">
                                </div>
                                <div class="flex justify-between items-center text-[10px]">
                                    <span>候诊 → 诊室</span>
                                    <input type="number" id="dist_3" value="10" class="w-16 text-right bg-white/50 border rounded px-1">
                                </div>
                                <div class="flex justify-between items-center text-[10px]">
                                    <span>诊室 → 收费</span>
                                    <input type="number" id="dist_4" value="40" class="w-16 text-right bg-white/50 border rounded px-1">
                                </div>
                                <div class="flex justify-between items-center text-[10px]">
                                    <span>收费 → 离院</span>
                                    <input type="number" id="dist_5" value="20" class="w-16 text-right bg-white/50 border rounded px-1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
             <!-- Collapsed Label -->
             <div class="hidden absolute inset-0 flex items-center justify-center collapsed-content opacity-0 transition-opacity duration-300">
                <span class="collapsed-text font-bold text-gray-400 tracking-widest text-xs uppercase">Config</span>
            </div>
        </div>

        <!-- Center: Canvas & Graph -->
        <div class="flex-1 glass-panel rounded-2xl flex flex-col relative overflow-hidden z-10">
            <!-- Layout View -->
            <div id="viewLayout" class="absolute inset-0 flex flex-col">
                <div class="absolute top-4 left-4 z-10 flex gap-2">
                    <div class="bg-white/80 backdrop-blur px-3 py-1.5 rounded-full text-[10px] font-bold text-gray-500 border border-white shadow-sm flex items-center gap-2">
                       <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                       <span>拖拽平移 (Drag)</span>
                    </div>
                     <div class="bg-white/80 backdrop-blur px-3 py-1.5 rounded-full text-[10px] font-bold text-gray-500 border border-white shadow-sm flex items-center gap-2">
                       <span>小人移动速度已按物理距离换算</span>
                    </div>
                </div>
                <div class="flex-1 relative cursor-move bg-white/30 canvas-bg" id="canvasWrapper">
                    <canvas id="simCanvas" class="absolute top-0 left-0 block"></canvas>
                </div>
            </div>

            <!-- Spatio-Temporal Graph View -->
            <div id="viewGraph" class="absolute inset-0 flex flex-col hidden bg-white">
                 <div class="absolute top-4 left-4 z-10 flex gap-2">
                    <div class="bg-white/80 backdrop-blur px-3 py-1.5 rounded-full text-[10px] font-bold text-gray-500 border border-white shadow-sm flex items-center gap-2">
                       <span class="text-purple-600">●</span> 泳道(空间)
                       <span class="text-gray-400">|</span>
                       <span class="text-gray-600">→</span> 轴向(时间)
                    </div>
                    <div class="bg-white/80 backdrop-blur px-3 py-1.5 rounded-full text-[10px] font-bold text-gray-500 border border-white shadow-sm flex items-center gap-2">
                       <div class="w-2 h-2 bg-red-400 rounded-sm"></div> 拥堵热力
                       <div class="w-6 h-0.5 bg-gray-800"></div> 患者轨迹(抽样)
                    </div>
                </div>
                <div class="flex-1 relative overflow-hidden p-8" id="graphWrapper">
                    <canvas id="graphCanvas" class="absolute top-0 left-0 block"></canvas>
                </div>
            </div>
        </div>

        <!-- Right Panel: Stats -->
        <div id="rightPanel" class="w-96 glass-panel rounded-2xl flex flex-col panel-transition relative z-20">
             <button onclick="togglePanel('right')" class="absolute -left-3 top-1/2 transform -translate-y-1/2 w-6 h-12 bg-white rounded-full shadow-md flex items-center justify-center border border-gray-100 cursor-pointer hover:bg-purple-50 z-30 group">
                <svg id="rightToggleIcon" xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-500 group-hover:text-purple-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
            </button>

            <div class="p-5 border-b border-white/40 flex-shrink-0 panel-content">
                <h2 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                    <span class="w-1.5 h-4 bg-pink-500 rounded-full"></span> 
                    任务书生成 (Program)
                </h2>
            </div>

            <div class="flex-1 overflow-y-auto p-4 panel-content space-y-4">
                
                <!-- 1. Area Analysis Card -->
                <div class="bg-white/60 p-4 rounded-xl border border-white/60 shadow-sm">
                    <div class="flex justify-between items-baseline mb-2">
                        <h3 class="text-xs font-bold text-gray-700 uppercase">最小使用面积建议</h3>
                        <span class="text-[10px] text-gray-400">基于峰值排队+GB标准</span>
                    </div>
                    <div class="flex items-baseline gap-2 mb-3">
                        <span class="text-3xl font-bold text-gray-800" id="total_area">0</span>
                        <span class="text-sm text-gray-500">m²</span>
                    </div>
                    
                    <!-- Breakdown Bar -->
                    <div class="w-full h-3 bg-gray-200 rounded-full flex overflow-hidden mb-2">
                        <div class="bg-blue-400 h-full" style="width: 30%" id="bar_func"></div>
                        <div class="bg-yellow-400 h-full" style="width: 30%" id="bar_wait"></div>
                        <div class="bg-gray-400 h-full" style="width: 40%" id="bar_circ"></div>
                    </div>
                    <div class="flex justify-between text-[10px] text-gray-500">
                        <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-blue-400"></div>功能区 <span id="val_func">0</span></div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-yellow-400"></div>候诊区 <span id="val_wait">0</span></div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-gray-400"></div>交通 <span id="val_circ">0</span></div>
                    </div>
                </div>

                <!-- 2. Detailed Table -->
                <div class="bg-white/50 rounded-xl border border-white/60 overflow-hidden shadow-sm">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-gray-50/50 text-gray-500 font-semibold border-b border-gray-100">
                            <tr>
                                <th class="py-2 px-3">空间类型</th>
                                <th class="py-2 px-3 text-right">参数/排队</th>
                                <th class="py-2 px-3 text-right">计算面积</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 text-gray-600">
                            <tr>
                                <td class="py-2 px-3 font-medium">诊室群</td>
                                <td class="py-2 px-3 text-right text-[10px]" id="info_doc_count">--</td>
                                <td class="py-2 px-3 text-right font-mono" id="area_doc_total">--</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-3 font-medium">服务窗口</td>
                                <td class="py-2 px-3 text-right text-[10px]" id="info_win_count">--</td>
                                <td class="py-2 px-3 text-right font-mono" id="area_win_total">--</td>
                            </tr>
                            <tr class="bg-yellow-50/30">
                                <td class="py-2 px-3 font-medium text-yellow-700">候诊区(动态)</td>
                                <td class="py-2 px-3 text-right text-[10px] text-yellow-600" id="info_wait_peak">--</td>
                                <td class="py-2 px-3 text-right font-mono font-bold text-yellow-700" id="area_wait_total">--</td>
                            </tr>
                            <tr class="bg-gray-50/30">
                                <td class="py-2 px-3 font-medium text-gray-600">交通走廊</td>
                                <td class="py-2 px-3 text-right text-[10px]" id="info_path_len">--</td>
                                <td class="py-2 px-3 text-right font-mono text-gray-600" id="area_circ_total">--</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 3. Chart -->
                <div class="bg-white/50 p-3 rounded-xl border border-white/60 shadow-sm h-32 relative">
                    <canvas id="queueChart"></canvas>
                </div>

                <div class="text-[10px] text-gray-400 text-center">
                    * 候诊面积按 1.5 m²/人 (GB标准) 计算<br>
                    * 交通面积 = 输入线长 × 走廊宽度
                </div>
            </div>

             <!-- Collapsed Label -->
             <div class="hidden absolute inset-0 flex items-center justify-center collapsed-content opacity-0 transition-opacity duration-300">
                <span class="collapsed-text font-bold text-gray-400 tracking-widest text-xs uppercase">Program</span>
            </div>
        </div>

    </main>

<script>
// ---------------- 核心配置 ----------------
const CONFIG = {
    canvasPadding: 50,
    nodeRadius: 28,
    patientRadius: 4,
    walkSpeed: 1.2, // m/s (Standard walking speed)
    maxTime: 8 * 60, // 8 hours in minutes
    waitAreaPerPerson: 1.5, // GB Standard
};

// Layout Nodes (Visual positions only)
const NODES = {
    ENTRANCE: { x: 100, y: 350, label: '入口', color: '#94a3b8' },
    REGISTRATION: { x: 300, y: 150, label: '挂号', color: '#60a5fa' },
    WAITING: { x: 400, y: 450, label: '候诊', color: '#fbbf24' },
    CONSULTATION: { x: 650, y: 450, label: '诊室', color: '#34d399' },
    PHARMACY: { x: 850, y: 200, label: '收费', color: '#a78bfa' },
    EXIT: { x: 1050, y: 350, label: '离院', color: '#cbd5e1' }
};

// Y-Axis for Spatio-Temporal Graph (Swimlanes)
const GRAPH_LANES = ['ENTRANCE', 'REGISTRATION', 'WAITING', 'CONSULTATION', 'PHARMACY', 'EXIT'];

let camera = { x: 0, y: 0, scale: 1, isDragging: false, startX: 0, startY: 0 };
let simulation = null;
let chartInstance = null;
let animationFrameId;
let currentView = 'layout'; // 'layout' or 'graph'

// ---------------- 仿真数据结构 ----------------
function initSimulationData() {
    const dailyFlow = parseInt(document.getElementById('dailyFlow').value);
    
    // Read Physical Inputs
    const distInputs = {
        'ENTRANCE-REGISTRATION': parseInt(document.getElementById('dist_1').value),
        'REGISTRATION-WAITING': parseInt(document.getElementById('dist_2').value),
        'WAITING-CONSULTATION': parseInt(document.getElementById('dist_3').value),
        'CONSULTATION-PHARMACY': parseInt(document.getElementById('dist_4').value),
        'PHARMACY-EXIT': parseInt(document.getElementById('dist_5').value)
    };

    // Calculate Physical Path Total for Report
    const totalPathLen = Object.values(distInputs).reduce((a,b)=>a+b, 0);

    return {
        running: false,
        paused: false,
        speed: 1,
        time: 0,
        arrivalRate: dailyFlow / 480, // per minute
        patients: [],
        distances: distInputs,
        totalPathLen: totalPathLen,
        resources: {
            REGISTRATION: { 
                capacity: parseInt(document.getElementById('res_reg').value), 
                queue: [], processing: [], 
                serviceTime: parseFloat(document.getElementById('time_reg').value),
                busyTime: 0
            },
            WAITING: { 
                capacity: 9999, queue: [], processing: [], busyTime: 0
            },
            CONSULTATION: {
                capacity: parseInt(document.getElementById('res_doc').value),
                processing: [],
                serviceTime: parseFloat(document.getElementById('time_doc').value),
                busyTime: 0
            },
            PHARMACY: {
                capacity: parseInt(document.getElementById('res_phar').value),
                queue: [], processing: [],
                serviceTime: parseFloat(document.getElementById('time_phar').value),
                busyTime: 0
            }
        },
        stats: {
            totalFinished: 0,
            peakQueue: { REGISTRATION: 0, WAITING: 0, PHARMACY: 0 },
            history: { time: [], q_wait: [] }
        },
        // Data for Spatio-Temporal Graph
        graphData: {
            nodeLoad: { REGISTRATION: [], WAITING: [], PHARMACY: [], CONSULTATION: [] }, // Heatmap data: [queueLen, queueLen...] per minute
            traces: [] // Array of selected patients' trajectories: [{t:time, node:index}, ...]
        }
    };
}

// ---------------- UI & Canvas Setup ----------------
const canvas = document.getElementById('simCanvas');
const ctx = canvas.getContext('2d');
const canvasWrapper = document.getElementById('canvasWrapper');

const graphCanvas = document.getElementById('graphCanvas');
const graphCtx = graphCanvas.getContext('2d');
const graphWrapper = document.getElementById('graphWrapper');

function resizeCanvas() {
    canvas.width = canvasWrapper.clientWidth;
    canvas.height = canvasWrapper.clientHeight;
    
    graphCanvas.width = graphWrapper.clientWidth;
    graphCanvas.height = graphWrapper.clientHeight;

    if(simulation) {
        if(currentView === 'layout') drawFrame();
        else drawTimeSpace();
    }
}
window.addEventListener('resize', resizeCanvas);

// Panning
canvasWrapper.addEventListener('mousedown', e => {
    camera.isDragging = true;
    camera.startX = e.clientX - camera.x;
    camera.startY = e.clientY - camera.y;
    canvasWrapper.style.cursor = 'grabbing';
});
window.addEventListener('mouseup', () => {
    camera.isDragging = false;
    canvasWrapper.style.cursor = 'move';
});
window.addEventListener('mousemove', e => {
    if (camera.isDragging) {
        camera.x = e.clientX - camera.startX;
        camera.y = e.clientY - camera.startY;
        if (!simulation.running) drawFrame();
    }
});

// View Switching
function switchView(view) {
    currentView = view;
    document.getElementById('viewLayout').className = view === 'layout' ? 'absolute inset-0 flex flex-col' : 'hidden';
    document.getElementById('viewGraph').className = view === 'graph' ? 'absolute inset-0 flex flex-col bg-white' : 'hidden';
    
    // Toggle Button Styles
    const btnLayout = document.getElementById('btnViewLayout');
    const btnGraph = document.getElementById('btnViewGraph');
    
    if(view === 'layout') {
        btnLayout.className = 'glass-btn active-view-btn px-3 py-2 rounded-lg text-xs font-semibold flex items-center gap-1 transition-all';
        btnGraph.className = 'glass-btn px-3 py-2 rounded-lg text-xs font-semibold text-gray-600 flex items-center gap-1 transition-all';
        drawFrame();
    } else {
        btnGraph.className = 'glass-btn active-view-btn px-3 py-2 rounded-lg text-xs font-semibold flex items-center gap-1 transition-all';
        btnLayout.className = 'glass-btn px-3 py-2 rounded-lg text-xs font-semibold text-gray-600 flex items-center gap-1 transition-all';
        drawTimeSpace();
    }
}


// Panel Toggle
function togglePanel(side) {
    const panel = document.getElementById(`${side}Panel`);
    const isLeft = side === 'left';
    const content = panel.querySelectorAll('.panel-content');
    const collapsedLabel = panel.querySelector('.collapsed-content');
    
    if (panel.classList.contains('w-12')) {
        panel.classList.remove('w-12');
        panel.classList.add(isLeft ? 'w-80' : 'w-96');
        content.forEach(el => el.classList.remove('hidden'));
        collapsedLabel.classList.add('hidden');
        collapsedLabel.classList.remove('opacity-100');
    } else {
        panel.classList.remove(isLeft ? 'w-80' : 'w-96');
        panel.classList.add('w-12');
        content.forEach(el => el.classList.add('hidden'));
        collapsedLabel.classList.remove('hidden');
        setTimeout(() => collapsedLabel.classList.add('opacity-100'), 50);
    }
    setTimeout(resizeCanvas, 400);
}

// Chart
function initChart() {
    const ctxChart = document.getElementById('queueChart').getContext('2d');
    chartInstance = new Chart(ctxChart, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{ 
                label: '候诊人数', 
                borderColor: '#fbbf24', 
                backgroundColor: 'rgba(251, 191, 36, 0.1)',
                borderWidth: 2, 
                data: [], 
                fill: true,
                pointRadius: 0, 
                tension: 0.4 
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { display: false },
                y: { grid: { color: 'rgba(0,0,0,0.05)' }, beginAtZero: true, suggestedMax: 20 }
            }
        }
    });
}

// ---------------- 仿真类与逻辑 ----------------

class Patient {
    constructor(id) {
        this.id = id;
        this.x = NODES.ENTRANCE.x;
        this.y = NODES.ENTRANCE.y;
        this.targetNode = 'REGISTRATION';
        this.state = 'walking'; 
        
        // Tracing
        this.isTraced = (id % 50 === 0); // Trace every 50th patient
        this.traceHistory = []; // {t, nodeIndex}

        // Calculate dynamic travel duration based on physical distance input
        this.updateTravelParams('ENTRANCE', 'REGISTRATION');
        
        this.isReturnVisit = Math.random() < (parseFloat(document.getElementById('returnRate').value) / 100);
        
        // Visual Jitter
        this.offsetX = (Math.random() - 0.5) * 20;
        this.offsetY = (Math.random() - 0.5) * 20;

        if(this.isTraced) this.logPosition(simulation.time, 'ENTRANCE');
    }

    logPosition(time, nodeName) {
        if(!this.isTraced) return;
        const laneIndex = GRAPH_LANES.indexOf(nodeName);
        if(laneIndex !== -1) {
            this.traceHistory.push({ t: time, lane: laneIndex });
        }
    }

    // Key Logic: Map Physical Distance to Simulation Time
    updateTravelParams(fromNodeName, toNodeName) {
        const key = `${fromNodeName}-${toNodeName}`;
        // Get physical distance in meters (user input)
        const physicalDist = simulation.distances[key] || 20; 
        // Calculate time needed to walk this distance (minutes)
        // Speed = 1.2 m/s = 72 m/min
        this.travelDuration = physicalDist / 72; 
        
        // Setup Visual Interpolation
        this.startPos = { x: NODES[fromNodeName].x, y: NODES[fromNodeName].y };
        this.endPos = { x: NODES[toNodeName].x, y: NODES[toNodeName].y };
        this.travelTimer = 0;

        // Log graph start of travel
        this.logPosition(simulation.time, fromNodeName);
    }

    update(dt) {
        if (this.state === 'finished') return;

        if (this.state === 'walking') {
            this.travelTimer += dt;
            
            // Linear Interpolation ratio
            let progress = this.travelTimer / this.travelDuration;
            
            if (progress >= 1) {
                // Arrived
                this.x = this.endPos.x + this.offsetX;
                this.y = this.endPos.y + this.offsetY;
                this.arrive();
            } else {
                // Moving
                this.x = this.startPos.x + (this.endPos.x - this.startPos.x) * progress + (this.offsetX * 0.1);
                this.y = this.startPos.y + (this.endPos.y - this.startPos.y) * progress + (this.offsetY * 0.1);
            }
        }
    }

    arrive() {
        const currentNode = this.targetNode;
        this.logPosition(simulation.time, currentNode);

        if (currentNode === 'REGISTRATION') {
            simulation.resources.REGISTRATION.queue.push(this);
            this.state = 'waiting';
        } else if (currentNode === 'WAITING') {
            simulation.resources.WAITING.queue.push(this);
            this.state = 'waiting';
        } else if (currentNode === 'CONSULTATION') {
            // Logic handled by resource processor
        } else if (currentNode === 'PHARMACY') {
            simulation.resources.PHARMACY.queue.push(this);
            this.state = 'waiting';
        } else if (currentNode === 'EXIT') {
            this.state = 'finished';
            this.logPosition(simulation.time, 'EXIT');
            simulation.stats.totalFinished++;
            if(this.isTraced) simulation.graphData.traces.push(this.traceHistory);
        }
    }
}

// Main Loop
function gameLoop(now) {
    if (!simulation.running || simulation.paused) return;

    let rawDt = now - lastFrameTime;
    lastFrameTime = now;
    let dt = (Math.min(rawDt, 100) / 1000) * simulation.speed; // minutes

    simulation.time += dt;

    // 1. Generate
    if (simulation.time < CONFIG.maxTime) {
        if (Math.random() < simulation.arrivalRate * dt) {
            simulation.patients.push(new Patient(simulation.patients.length));
        }
    } else if (simulation.patients.every(p => p.state === 'finished')) {
        simulation.running = false;
        alert("仿真完成");
        return;
    }

    // 2. Resources
    processRegAndPharm(dt);
    processDoctor(dt);

    // 3. Move
    simulation.patients.forEach(p => p.update(dt));

    // 4. Stats Recording
    if (Math.floor(simulation.time) % 5 === 0) {
        recordStats();
    }
    // High res recording for heatmap (every 1 min)
    if (Math.floor(simulation.time) > simulation.graphData.nodeLoad.REGISTRATION.length) {
         recordGraphData();
    }


    // 5. Draw
    if (currentView === 'layout') drawFrame();
    else if (currentView === 'graph') drawTimeSpace();
    
    // 6. UI Update (Throttled)
    if (simulation.time % 2 < dt) updateCalculations();

    animationFrameId = requestAnimationFrame(gameLoop);
}

function processRegAndPharm(dt) {
    const res = simulation.resources;
    
    // Reg
    while (res.REGISTRATION.processing.length < res.REGISTRATION.capacity && res.REGISTRATION.queue.length > 0) {
        const p = res.REGISTRATION.queue.shift();
        res.REGISTRATION.processing.push({ p: p, t: res.REGISTRATION.serviceTime });
    }
    res.REGISTRATION.processing.forEach((slot, i) => {
        slot.t -= dt;
        if (slot.t <= 0) {
            res.REGISTRATION.processing.splice(i, 1);
            slot.p.targetNode = 'WAITING';
            slot.p.updateTravelParams('REGISTRATION', 'WAITING');
            slot.p.state = 'walking';
        }
    });

    // Pharm
    while (res.PHARMACY.processing.length < res.PHARMACY.capacity && res.PHARMACY.queue.length > 0) {
        const p = res.PHARMACY.queue.shift();
        res.PHARMACY.processing.push({ p: p, t: res.PHARMACY.serviceTime });
    }
    res.PHARMACY.processing.forEach((slot, i) => {
        slot.t -= dt;
        if (slot.t <= 0) {
            res.PHARMACY.processing.splice(i, 1);
            slot.p.targetNode = 'EXIT';
            slot.p.updateTravelParams('PHARMACY', 'EXIT');
            slot.p.state = 'walking';
        }
    });
}

function processDoctor(dt) {
    const res = simulation.resources;
    // Waiting -> Consultation logic
    while (res.CONSULTATION.processing.length < res.CONSULTATION.capacity && res.WAITING.queue.length > 0) {
        const p = res.WAITING.queue.shift();
        // Start walking to doctor
        p.targetNode = 'CONSULTATION';
        p.updateTravelParams('WAITING', 'CONSULTATION'); 
        p.state = 'walking';
        
        // Reserve spot, but timer only starts when arrive
        res.CONSULTATION.processing.push({ p: p, t: res.CONSULTATION.serviceTime, arrived: false });
    }

    for (let i = res.CONSULTATION.processing.length - 1; i >= 0; i--) {
        let slot = res.CONSULTATION.processing[i];
        
        // Logic check for visual walking
        if (slot.p.travelTimer >= slot.p.travelDuration) {
            // Patient is physically at the doctor
            slot.p.state = 'service';
            slot.t -= dt;
        }

        if (slot.t <= 0) {
            res.CONSULTATION.processing.splice(i, 1);
            if (slot.p.isReturnVisit) {
                 slot.p.isReturnVisit = false;
                 slot.p.targetNode = 'PHARMACY'; // Simplified
                 slot.p.updateTravelParams('CONSULTATION', 'PHARMACY');
            } else {
                 slot.p.targetNode = 'PHARMACY';
                 slot.p.updateTravelParams('CONSULTATION', 'PHARMACY');
            }
            slot.p.state = 'walking';
        }
    }
}

// ---------------- 算量核心 ----------------

function updateCalculations() {
    // 1. Read Inputs
    const unitAreaDoc = parseFloat(document.getElementById('area_doc_unit').value);
    const unitAreaWin = parseFloat(document.getElementById('area_win_unit').value);
    const widthCorridor = parseFloat(document.getElementById('width_corridor').value);
    
    const countDoc = parseInt(document.getElementById('res_doc').value);
    const countReg = parseInt(document.getElementById('res_reg').value);
    const countPhar = parseInt(document.getElementById('res_phar').value);
    
    const peakWait = simulation.stats.peakQueue.WAITING;
    const totalPath = simulation.totalPathLen;

    // 2. Calculate Areas
    const areaFunc = (countDoc * unitAreaDoc) + ((countReg + countPhar) * unitAreaWin);
    const areaWait = Math.ceil(peakWait * CONFIG.waitAreaPerPerson * 1.2); // 1.2 Buffer
    const areaCirc = Math.ceil(totalPath * widthCorridor);
    
    const totalArea = areaFunc + areaWait + areaCirc;

    // 3. Update DOM
    document.getElementById('total_area').innerText = totalArea;
    
    // Breakdown Bar
    const pFunc = (areaFunc / totalArea) * 100;
    const pWait = (areaWait / totalArea) * 100;
    const pCirc = (areaCirc / totalArea) * 100;
    
    document.getElementById('bar_func').style.width = pFunc + '%';
    document.getElementById('bar_wait').style.width = pWait + '%';
    document.getElementById('bar_circ').style.width = pCirc + '%';
    
    document.getElementById('val_func').innerText = areaFunc;
    document.getElementById('val_wait').innerText = areaWait;
    document.getElementById('val_circ').innerText = areaCirc;
    
    // Table Details
    document.getElementById('info_doc_count').innerText = `${countDoc}间 × ${unitAreaDoc}`;
    document.getElementById('area_doc_total').innerText = (countDoc * unitAreaDoc);
    
    document.getElementById('info_win_count').innerText = `${countReg+countPhar}个 × ${unitAreaWin}`;
    document.getElementById('area_win_total').innerText = ((countReg+countPhar) * unitAreaWin);
    
    document.getElementById('info_wait_peak').innerText = `${peakWait}人 (峰值)`;
    document.getElementById('area_wait_total').innerText = areaWait;
    
    document.getElementById('info_path_len').innerText = `${totalPath}m × ${widthCorridor}m`;
    document.getElementById('area_circ_total').innerText = areaCirc;
}

function recordStats() {
    const s = simulation.stats;
    const r = simulation.resources;
    
    // Update Peaks
    s.peakQueue.WAITING = Math.max(s.peakQueue.WAITING, r.WAITING.queue.length);
    
    // Chart
    if (s.history.time.length > 40) {
        s.history.q_wait.shift();
        s.history.time.shift();
    }
    s.history.time.push('');
    s.history.q_wait.push(r.WAITING.queue.length);
    
    chartInstance.data.datasets[0].data = s.history.q_wait;
    chartInstance.update('none');
}

function recordGraphData() {
    const g = simulation.graphData.nodeLoad;
    const r = simulation.resources;
    
    g.REGISTRATION.push(r.REGISTRATION.queue.length);
    g.WAITING.push(r.WAITING.queue.length);
    g.PHARMACY.push(r.PHARMACY.queue.length);
    g.CONSULTATION.push(r.CONSULTATION.processing.length); // Use active processing for doctors
}

// ---------------- 绘图 ----------------
function drawFrame() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(camera.x, camera.y);
    ctx.scale(camera.scale, camera.scale);

    // Draw Paths (Visualizing physical connection)
    ctx.strokeStyle = '#cbd5e1';
    ctx.lineWidth = 4;
    ctx.lineCap = 'round';
    
    const drawLine = (n1, n2) => {
        ctx.beginPath();
        ctx.moveTo(NODES[n1].x, NODES[n1].y);
        ctx.lineTo(NODES[n2].x, NODES[n2].y);
        ctx.stroke();
    };
    drawLine('ENTRANCE', 'REGISTRATION');
    drawLine('REGISTRATION', 'WAITING');
    drawLine('WAITING', 'CONSULTATION');
    drawLine('CONSULTATION', 'PHARMACY');
    drawLine('PHARMACY', 'EXIT');

    // Draw Nodes
    Object.values(NODES).forEach(n => {
        ctx.fillStyle = n.color;
        ctx.beginPath();
        ctx.arc(n.x, n.y, CONFIG.nodeRadius, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.8)';
        ctx.font = 'bold 10px Inter';
        ctx.textAlign = 'center';
        ctx.fillText(n.label, n.x, n.y+4);
    });

    // Draw Patients
    simulation.patients.forEach(p => {
        if(p.state === 'finished') return;
        ctx.fillStyle = p.state === 'waiting' ? '#ef4444' : '#2563eb';
        ctx.beginPath();
        ctx.arc(p.x, p.y, CONFIG.patientRadius, 0, Math.PI*2);
        ctx.fill();
    });

    ctx.restore();
}

// Spatio-Temporal Graph Renderer
function drawTimeSpace() {
    graphCtx.clearRect(0, 0, graphCanvas.width, graphCanvas.height);
    
    // Layout Constants
    const margin = { top: 40, right: 20, bottom: 40, left: 80 };
    const w = graphCanvas.width - margin.left - margin.right;
    const h = graphCanvas.height - margin.top - margin.bottom;
    const laneH = h / GRAPH_LANES.length;
    
    // 1. Draw Axis & Lanes
    graphCtx.save();
    graphCtx.translate(margin.left, margin.top);
    
    // Labels
    graphCtx.font = '12px Inter';
    graphCtx.textAlign = 'right';
    graphCtx.textBaseline = 'middle';
    
    GRAPH_LANES.forEach((lane, i) => {
        const y = i * laneH;
        
        // Draw Heatmap Strip Background
        // Data mapping: Time (x) -> Color
        const data = simulation.graphData.nodeLoad[lane];
        if (data && data.length > 0) {
            const timeScale = w / CONFIG.maxTime;
            const blockW = Math.max(1, timeScale);
            
            for (let t = 0; t < data.length; t++) {
                const load = data[t];
                // Color Map: Green (0) -> Red (20+)
                const intensity = Math.min(1, load / 20); 
                // Simple Heatmap Color
                const r = Math.floor(255 * intensity);
                const g = Math.floor(255 * (1 - intensity));
                const b = 100;
                
                graphCtx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.3)`;
                graphCtx.fillRect(t * timeScale, y, blockW + 1, laneH - 2);
            }
        } else {
             // Gray empty lane
             graphCtx.fillStyle = '#f8fafc';
             graphCtx.fillRect(0, y, w, laneH - 2);
        }

        // Labels
        graphCtx.fillStyle = '#475569';
        graphCtx.fillText(NODES[lane].label, -10, y + laneH/2);
    });

    // 2. Draw Time Axis
    graphCtx.strokeStyle = '#cbd5e1';
    graphCtx.lineWidth = 1;
    graphCtx.beginPath();
    graphCtx.moveTo(0, h);
    graphCtx.lineTo(w, h);
    graphCtx.stroke();
    
    graphCtx.textAlign = 'center';
    graphCtx.textBaseline = 'top';
    for(let i=0; i<=8; i++) {
        const x = (i * 60 / CONFIG.maxTime) * w;
        graphCtx.fillText(`${i}h`, x, h + 10);
        graphCtx.beginPath();
        graphCtx.moveTo(x, 0);
        graphCtx.lineTo(x, h);
        graphCtx.strokeStyle = '#f1f5f9';
        graphCtx.stroke();
    }

    // 3. Draw Patient Traces (Marey Diagram Lines)
    // Draw finished traces
    const allTraces = [...simulation.graphData.traces];
    // Also draw currently active traced patients
    simulation.patients.forEach(p => {
        if(p.isTraced && p.state !== 'finished') allTraces.push(p.traceHistory);
    });

    graphCtx.lineWidth = 1.5;
    
    allTraces.forEach((trace, idx) => {
        if(trace.length < 2) return;
        
        graphCtx.strokeStyle = `rgba(50, 50, 50, 0.4)`;
        graphCtx.beginPath();
        
        const timeScale = w / CONFIG.maxTime;
        
        trace.forEach((pt, i) => {
            const x = pt.t * timeScale;
            const y = pt.lane * laneH + laneH/2;
            
            if(i === 0) graphCtx.moveTo(x, y);
            else graphCtx.lineTo(x, y);
        });
        
        graphCtx.stroke();
    });

    // 4. Current Time Indicator
    const curX = (simulation.time / CONFIG.maxTime) * w;
    if (curX <= w) {
        graphCtx.strokeStyle = '#ef4444';
        graphCtx.lineWidth = 2;
        graphCtx.beginPath();
        graphCtx.moveTo(curX, 0);
        graphCtx.lineTo(curX, h);
        graphCtx.stroke();
    }

    graphCtx.restore();
}

// Control
let lastFrameTime = 0;
function toggleSimulation() {
    if (!simulation) {
        simulation = initSimulationData();
        resizeCanvas();
    }
    simulation.running = !simulation.running;
    if(simulation.running) {
        lastFrameTime = performance.now();
        gameLoop(lastFrameTime);
        document.getElementById('iconPlay').classList.add('hidden');
        document.getElementById('iconPause').classList.remove('hidden');
    } else {
        document.getElementById('iconPlay').classList.remove('hidden');
        document.getElementById('iconPause').classList.add('hidden');
    }
}
function resetSimulation() {
    simulation = initSimulationData();
    simulation.running = false;
    document.getElementById('iconPlay').classList.remove('hidden');
    document.getElementById('iconPause').classList.add('hidden');
    document.getElementById('simTimeDisplay').innerText = "00:00";
    resizeCanvas();
    updateCalculations();
}
function changeSpeed(v) { 
    if(simulation) simulation.speed = v; 
    document.querySelectorAll('[id^=speed]').forEach(e=>e.className=e.className.replace('bg-purple-100','hover:bg-white/50'));
    document.getElementById('speed'+v).className = "px-3 py-1.5 text-xs font-bold rounded-lg bg-purple-100 text-purple-700 transition";
}

// Init
initChart();
simulation = initSimulationData();
resizeCanvas();
drawFrame();
updateCalculations();

</script>
</body>
</html>
