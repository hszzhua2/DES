<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>门诊复杂流线效能仿真系统 Pro+ (Liquid Glass)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-surface: rgba(255, 255, 255, 0.45);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-highlight: rgba(255, 255, 255, 0.9);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #3b82f6 100%);
            --text-main: #1e293b;
            --text-sub: #475569;
        }

        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background: #eef2ff;
            color: var(--text-main);
            overflow: hidden;
        }

        /* ---------------- Liquid Background Blobs ---------------- */
        .liquid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            overflow: hidden;
            background: radial-gradient(circle at 50% 50%, #f0f5ff, #e0e7ff);
        }

        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.7;
            animation: float 20s infinite ease-in-out;
        }

        .blob-1 {
            top: -10%;
            left: -10%;
            width: 50vw;
            height: 50vw;
            background: linear-gradient(135deg, #c7d2fe, #a5b4fc);
            animation-delay: 0s;
        }

        .blob-2 {
            bottom: -10%;
            right: -10%;
            width: 40vw;
            height: 40vw;
            background: linear-gradient(135deg, #fbcfe8, #f472b6);
            animation-delay: -5s;
        }

        .blob-3 {
            top: 30%;
            left: 40%;
            width: 30vw;
            height: 30vw;
            background: linear-gradient(135deg, #bae6fd, #7dd3fc);
            animation-delay: -10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }

        /* ---------------- Glassmorphism Panels ---------------- */
        .glass-panel {
            background: linear-gradient(120deg, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.2));
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-top: 1px solid rgba(255, 255, 255, 0.7);
            border-left: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 
                0 8px 32px 0 rgba(31, 38, 135, 0.1),
                inset 0 0 0 1px rgba(255, 255, 255, 0.2);
            border-radius: 24px;
        }

        /* ---------------- Liquid Inputs (Recessed) ---------------- */
        .glass-input {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            box-shadow: 
                inset 2px 2px 5px rgba(163, 177, 198, 0.3),
                inset -2px -2px 5px rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            color: var(--text-main);
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.6);
            box-shadow: 
                inset 1px 1px 2px rgba(163, 177, 198, 0.2),
                inset -1px -1px 2px rgba(255, 255, 255, 0.9),
                0 0 0 2px rgba(99, 102, 241, 0.3);
            outline: none;
        }

        /* ---------------- Liquid Buttons (Floating) ---------------- */
        .glass-btn {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 4px 12px rgba(0,0,0,0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            border-radius: 14px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-weight: 600;
            color: #475569;
        }
        .glass-btn:hover {
            background: rgba(255, 255, 255, 0.7);
            transform: translateY(-2px);
            box-shadow: 
                0 8px 20px rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            color: #334155;
        }
        .glass-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .active-view-btn {
            background: var(--primary-gradient);
            color: white !important;
            border: none;
            box-shadow: 
                0 4px 15px rgba(99, 102, 241, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        .active-view-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #2563eb 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        /* ---------------- Canvas & Layout ---------------- */
        .canvas-container {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.02);
            background: rgba(255,255,255,0.4);
        }

        .canvas-bg {
            background-image: 
                radial-gradient(rgba(99, 102, 241, 0.15) 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* ---------------- Transitions ---------------- */
        .panel-transition {
            transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* ---------------- Scrollbar ---------------- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { 
            background: rgba(99, 102, 241, 0.2); 
            border-radius: 10px; 
            border: 2px solid transparent;
            background-clip: content-box;
        }
        ::-webkit-scrollbar-thumb:hover { background-color: rgba(99, 102, 241, 0.4); }

        .collapsed-text {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            white-space: nowrap;
            letter-spacing: 2px;
            color: rgba(0,0,0,0.3);
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
        }

        /* Header Logo Block */
        .logo-block {
            background: var(--primary-gradient);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            border-radius: 14px;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm">

    <!-- Background Blobs -->
    <div class="liquid-bg">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <!-- Header -->
    <header class="h-16 glass-panel z-50 flex items-center justify-between px-6 mx-4 mt-4 rounded-3xl flex-shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 logo-block flex items-center justify-center text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
            </div>
            <div>
                <h1 class="text-base font-bold text-gray-800 tracking-tight drop-shadow-sm">门诊空间效能仿真 Pro+</h1>
                <p class="text-[10px] text-gray-500 font-medium tracking-wide">WORKFLOW: REG -> NURSE -> WAIT -> DOC -> EXAM/PHARM</p>
            </div>
        </div>

        <!-- Simulation Controls -->
        <div class="flex items-center gap-3 bg-white/30 p-1.5 rounded-2xl shadow-inner border border-white/40 backdrop-blur-sm">
            <button onclick="toggleSimulation()" id="btnPlayPause" class="w-9 h-9 flex items-center justify-center rounded-xl bg-white shadow-sm text-indigo-600 hover:text-indigo-700 transition-all hover:scale-105 active:scale-95">
                <svg id="iconPlay" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                <svg id="iconPause" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
            </button>
            <div class="h-5 w-px bg-gray-400/30 mx-1"></div>
            <button onclick="changeSpeed(1)" class="px-3 py-1.5 text-[10px] font-bold rounded-lg bg-indigo-100/50 text-indigo-700 transition-all hover:bg-white/60" id="speed1">x1</button>
            <button onclick="changeSpeed(10)" class="px-3 py-1.5 text-[10px] font-semibold rounded-lg hover:bg-white/60 text-gray-600 transition-all" id="speed10">x10</button>
            <button onclick="changeSpeed(100)" class="px-3 py-1.5 text-[10px] font-semibold rounded-lg hover:bg-white/60 text-gray-600 transition-all" id="speed100">x100</button>
            <div class="px-3 text-xs font-mono font-bold text-indigo-800 w-14 text-center tracking-wider" id="simTimeDisplay">00:00</div>
        </div>

        <div class="flex gap-3">
             <button onclick="switchView('layout')" id="btnViewLayout" class="glass-btn active-view-btn px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" /></svg>
                平面动线
            </button>
            <button onclick="switchView('graph')" id="btnViewGraph" class="glass-btn px-4 py-2 rounded-xl text-xs font-bold text-gray-600 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                时空图谱
            </button>
            <button onclick="resetSimulation()" class="glass-btn px-4 py-2 rounded-xl text-xs font-bold text-gray-600">
                重置
            </button>
        </div>
    </header>

    <!-- Main Body -->
    <main class="flex-1 flex overflow-hidden p-4 gap-4 relative">

        <!-- Left Panel: Parameters -->
        <div id="leftPanel" class="w-80 glass-panel rounded-3xl flex flex-col panel-transition relative z-20">
            <button onclick="togglePanel('left')" class="absolute -right-4 top-14 w-8 h-8 bg-white/80 backdrop-blur rounded-full shadow-lg border border-white flex items-center justify-center cursor-pointer hover:bg-white hover:scale-110 transition-all z-30 group">
                <svg class="h-4 w-4 text-gray-500 group-hover:text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            
            <div class="p-5 border-b border-white/30 flex-shrink-0 panel-content">
                <h2 class="text-xs font-bold text-indigo-900 uppercase tracking-widest flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-indigo-500 shadow-[0_0_8px_rgba(99,102,241,0.6)]"></span>
                    参数配置 (Input)
                </h2>
            </div>
            
            <div class="overflow-y-auto flex-1 p-5 space-y-6 panel-content">
                <!-- Global -->
                <div class="bg-white/20 p-3 rounded-2xl border border-white/30 shadow-sm">
                    <label class="block text-[10px] font-bold text-indigo-600 uppercase mb-2">总体流量设定</label>
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <span class="text-[10px] text-gray-500 block mb-1">门诊量(人/h)</span>
                            <input type="number" id="hourlyFlow" value="180" class="w-full glass-input px-3 py-1.5 text-xs font-bold text-indigo-900">
                        </div>
                        <div class="flex-1">
                            <span class="text-[10px] text-gray-500 block mb-1">检查率(%)</span>
                            <input type="number" id="examRate" value="35" class="w-full glass-input px-3 py-1.5 text-xs font-bold text-indigo-900">
                        </div>
                    </div>
                </div>

                 <!-- Warning Threshold -->
                <div class="bg-red-50/50 p-3 rounded-2xl border border-red-100/60 shadow-sm">
                    <label class="block text-[10px] text-red-500 mb-2 font-bold flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        拥堵预警阈值
                    </label>
                    <div class="flex items-center gap-2">
                         <input type="number" id="warn_thresh" value="8" class="w-full glass-input !bg-white/60 !border-red-200 px-3 py-1.5 text-xs text-red-600 font-bold font-mono">
                         <span class="text-[8px] text-red-400 shrink-0 font-medium">人/节点 (触发红警)</span>
                    </div>
                </div>

                <!-- Distance Inputs (New) -->
                <div class="bg-blue-50/30 p-3 rounded-2xl border border-blue-100/50 shadow-sm">
                    <label class="block text-[10px] font-bold text-blue-600 uppercase mb-2">关键路径距离 D (m)</label>
                    <div class="space-y-2 text-[10px]">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">A挂号 → B大厅</span>
                            <input type="number" id="d_A_B" value="15" class="w-16 glass-input text-center px-1 py-1 font-bold">
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">B大厅 → C1护士</span>
                            <input type="number" id="d_B_C1" value="25" class="w-16 glass-input text-center px-1 py-1 font-bold">
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">C2候诊 → D诊室</span>
                            <input type="number" id="d_C_D" value="10" class="w-16 glass-input text-center px-1 py-1 font-bold">
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">D诊室 → G检查</span>
                            <input type="number" id="d_D_G" value="40" class="w-16 glass-input text-center px-1 py-1 font-bold">
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">D诊室 → E药房</span>
                            <input type="number" id="d_D_E" value="35" class="w-16 glass-input text-center px-1 py-1 font-bold">
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">E药房 → F离院</span>
                            <input type="number" id="d_E_F" value="20" class="w-16 glass-input text-center px-1 py-1 font-bold">
                        </div>
                    </div>
                </div>

                <!-- Resources Group -->
                <div class="space-y-3">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase border-b border-gray-200/50 pb-1">节点资源 (Resources)</label>
                    
                    <div class="grid grid-cols-4 gap-2 px-2 text-[9px] font-bold text-gray-400">
                        <span class="col-span-2">节点名称</span>
                        <span class="text-center">数量 (个)</span>
                        <span class="text-center">耗时 (分)</span>
                    </div>

                    <div class="space-y-2">
                        <!-- Helper Mixin style via classes -->
                        <div class="grid grid-cols-4 gap-2 items-center bg-white/30 p-2 rounded-xl border border-white/40">
                            <span class="col-span-2 text-[10px] font-semibold text-gray-700 pl-1">A. 挂号窗口</span>
                            <input type="number" id="res_reg" value="3" class="glass-input rounded-lg px-1 py-1 text-xs text-center font-bold">
                            <input type="number" id="time_reg" value="2" class="glass-input rounded-lg px-1 py-1 text-xs text-center text-gray-600">
                        </div>

                        <div class="grid grid-cols-4 gap-2 items-center bg-white/30 p-2 rounded-xl border border-white/40">
                            <span class="col-span-2 text-[10px] font-semibold text-gray-700 pl-1">C1. 护士报到</span>
                            <input type="number" id="res_nurse" value="2" class="glass-input rounded-lg px-1 py-1 text-xs text-center font-bold">
                            <input type="number" id="time_nurse" value="1" class="glass-input rounded-lg px-1 py-1 text-xs text-center text-gray-600">
                        </div>

                        <div class="grid grid-cols-4 gap-2 items-center bg-white/30 p-2 rounded-xl border border-white/40">
                            <span class="col-span-2 text-[10px] font-semibold text-gray-700 pl-1">D. 诊室数量</span>
                            <input type="number" id="res_doc" value="12" class="glass-input rounded-lg px-1 py-1 text-xs text-center font-bold">
                            <input type="number" id="time_doc" value="10" class="glass-input rounded-lg px-1 py-1 text-xs text-center text-gray-600">
                        </div>

                        <div class="grid grid-cols-4 gap-2 items-center bg-white/30 p-2 rounded-xl border border-white/40">
                            <span class="col-span-2 text-[10px] font-semibold text-gray-700 pl-1">G. 检查科室</span>
                            <input type="number" id="res_exam" value="5" class="glass-input rounded-lg px-1 py-1 text-xs text-center font-bold">
                            <input type="number" id="time_exam" value="15" class="glass-input rounded-lg px-1 py-1 text-xs text-center text-gray-600">
                        </div>

                        <div class="grid grid-cols-4 gap-2 items-center bg-white/30 p-2 rounded-xl border border-white/40">
                            <span class="col-span-2 text-[10px] font-semibold text-gray-700 pl-1">E. 药房窗口</span>
                            <input type="number" id="res_phar" value="4" class="glass-input rounded-lg px-1 py-1 text-xs text-center font-bold">
                            <input type="number" id="time_phar" value="3" class="glass-input rounded-lg px-1 py-1 text-xs text-center text-gray-600">
                        </div>
                    </div>
                </div>

                <!-- Area Parameters -->
                <div class="space-y-3 pt-2">
                     <label class="block text-[10px] font-bold text-green-600 uppercase border-b border-green-200/50 pb-1">单位面积指标 S (m²)</label>
                     <div class="grid grid-cols-2 gap-3 text-[10px]">
                        <div>
                            <span class="text-gray-500 block mb-1 pl-1">单诊室</span>
                            <input type="number" id="area_doc_unit" value="12" class="w-full glass-input rounded-lg px-2 py-1.5 font-medium">
                        </div>
                        <div>
                            <span class="text-gray-500 block mb-1 pl-1">单检查室</span>
                            <input type="number" id="area_exam_unit" value="20" class="w-full glass-input rounded-lg px-2 py-1.5 font-medium">
                        </div>
                        <div>
                            <span class="text-gray-500 block mb-1 pl-1">护士站</span>
                            <input type="number" id="area_nurse" value="15" class="w-full glass-input rounded-lg px-2 py-1.5 font-medium">
                        </div>
                         <div>
                            <span class="text-gray-500 block mb-1 pl-1">候诊(人均)</span>
                            <input type="number" id="area_wait_unit" value="2.0" class="w-full glass-input rounded-lg px-2 py-1.5 font-medium">
                        </div>
                     </div>
                </div>

            </div>
            <!-- Collapsed -->
            <div class="hidden absolute inset-0 flex items-center justify-center collapsed-content opacity-0">
                <span class="collapsed-text font-black text-gray-400/50 text-xs">CONFIG</span>
            </div>
        </div>

        <!-- Center: Canvas -->
        <div class="flex-1 glass-panel rounded-3xl flex flex-col relative overflow-hidden z-10 shadow-xl">
            <!-- Layout View -->
            <div id="viewLayout" class="absolute inset-0 flex flex-col h-full w-full">
                <div class="absolute top-4 left-4 z-10 flex gap-2 pointer-events-none">
                     <div class="bg-white/60 backdrop-blur-md px-3 py-1.5 rounded-full shadow-lg border border-white/60 text-[10px] font-bold text-indigo-900 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" /></svg>
                        <span>按住拖拽 / 滚轮缩放</span>
                    </div>
                </div>
                <button onclick="resetCamera('layout')" class="absolute top-4 right-4 z-10 glass-btn px-3 py-1.5 rounded-xl shadow-lg text-[10px] font-bold text-indigo-600 hover:text-indigo-800">
                    复位视角
                </button>
                <div class="flex-1 relative cursor-move canvas-container canvas-bg h-full m-1" id="layoutWrapper">
                    <canvas id="simCanvas" class="block w-full h-full"></canvas>
                </div>
            </div>

            <!-- Graph View -->
            <div id="viewGraph" class="absolute inset-0 flex flex-col hidden h-full w-full">
                 <div class="absolute top-4 left-4 z-10 flex gap-2 pointer-events-none">
                     <div class="bg-white/60 backdrop-blur-md px-3 py-1.5 rounded-full shadow-lg border border-white/60 text-[10px] font-bold text-indigo-900 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg>
                         <span>可缩放/拖拽查看长时数据 (0-8小时)</span>
                    </div>
                </div>
                <button onclick="resetCamera('graph')" class="absolute top-4 right-4 z-10 glass-btn px-3 py-1.5 rounded-xl shadow-lg text-[10px] font-bold text-indigo-600 hover:text-indigo-800">
                    复位图谱
                </button>
                <div class="flex-1 relative overflow-hidden cursor-move bg-white/50 h-full m-1 rounded-2xl" id="graphWrapper">
                    <canvas id="graphCanvas" class="block w-full h-full"></canvas>
                </div>
            </div>
        </div>

        <!-- Right Panel: Report -->
        <div id="rightPanel" class="w-80 glass-panel rounded-3xl flex flex-col panel-transition relative z-20">
             <button onclick="togglePanel('right')" class="absolute -left-4 top-14 w-8 h-8 bg-white/80 backdrop-blur rounded-full shadow-lg border border-white flex items-center justify-center cursor-pointer hover:bg-white hover:scale-110 transition-all z-30 group">
                <svg class="h-4 w-4 text-gray-500 group-hover:text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>

            <div class="p-5 border-b border-white/30 flex-shrink-0 panel-content">
                <h2 class="text-xs font-bold text-indigo-900 uppercase tracking-widest flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-pink-500 shadow-[0_0_8px_rgba(236,72,153,0.6)]"></span>
                    设计任务书 (Program)
                </h2>
            </div>

            <div class="flex-1 overflow-y-auto p-5 panel-content space-y-5">
                
                <!-- Summary Card -->
                <div class="bg-gradient-to-br from-white/60 to-white/20 p-4 rounded-2xl border border-white/50 shadow-sm relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 w-16 h-16 bg-blue-100 rounded-full blur-xl opacity-50"></div>
                    <div class="text-[10px] text-gray-500 uppercase font-bold mb-1 relative z-10">建议总使用面积</div>
                    <div class="flex items-baseline gap-2 relative z-10">
                        <span class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600 drop-shadow-sm" id="total_area">0</span>
                        <span class="text-xs text-gray-600 font-bold">m²</span>
                    </div>
                    <!-- Mini Chart -->
                     <div class="w-full h-2.5 bg-gray-200/50 rounded-full flex overflow-hidden mt-3 shadow-inner">
                        <div class="bg-blue-500 h-full shadow-[0_0_5px_rgba(59,130,246,0.5)]" style="width: 40%" id="bar_med"></div>
                        <div class="bg-yellow-400 h-full shadow-[0_0_5px_rgba(250,204,21,0.5)]" style="width: 30%" id="bar_wait"></div>
                        <div class="bg-gray-400 h-full" style="width: 30%" id="bar_circ"></div>
                    </div>
                     <div class="flex justify-between text-[9px] text-gray-500 mt-2 font-medium">
                        <span class="flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div>医疗</span>
                        <span class="flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-yellow-400"></div>候诊</span>
                        <span class="flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-gray-400"></div>交通</span>
                    </div>
                </div>

                <!-- New Efficiency Metrics -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white/40 p-3 rounded-2xl border border-white/50 shadow-sm flex flex-col items-center justify-center">
                        <span class="text-[9px] text-gray-500 uppercase font-bold mb-1">人均行走距离</span>
                        <span class="text-lg font-black text-indigo-700 font-mono" id="val_avg_dist">0</span>
                        <span class="text-[9px] text-indigo-400 font-bold">meters</span>
                    </div>
                    <div class="bg-white/40 p-3 rounded-2xl border border-white/50 shadow-sm flex flex-col items-center justify-center">
                        <span class="text-[9px] text-gray-500 uppercase font-bold mb-1">人均使用面积</span>
                        <span class="text-lg font-black text-indigo-700 font-mono" id="val_area_per_person">0</span>
                        <span class="text-[9px] text-indigo-400 font-bold">m²/person</span>
                    </div>
                </div>

                <!-- Detailed List -->
                <div class="bg-white/30 rounded-2xl border border-white/40 overflow-hidden shadow-sm">
                    <table class="w-full text-[10px]">
                        <thead class="bg-white/40 text-gray-500 border-b border-white/40">
                            <tr>
                                <th class="p-3 text-left font-bold pl-4">功能用房</th>
                                <th class="p-3 text-right font-bold">数量</th>
                                <th class="p-3 text-right font-bold pr-4">面积(m²)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/30 text-gray-700">
                            <tr>
                                <td class="p-2.5 pl-4">挂号/收费</td>
                                <td class="p-2.5 text-right font-medium" id="txt_reg_count">-</td>
                                <td class="p-2.5 text-right font-mono font-bold text-indigo-700 pr-4" id="val_reg_area">-</td>
                            </tr>
                            <tr>
                                <td class="p-2.5 pl-4">护士站(C1)</td>
                                <td class="p-2.5 text-right font-medium">1</td>
                                <td class="p-2.5 text-right font-mono font-bold text-indigo-700 pr-4" id="val_nurse_area">-</td>
                            </tr>
                             <tr class="bg-yellow-50/30">
                                <td class="p-2.5 pl-4 text-yellow-800">一级候诊(C2)</td>
                                <td class="p-2.5 text-right text-yellow-600 font-bold" id="val_wait1_peak">0</td>
                                <td class="p-2.5 text-right font-mono font-bold text-yellow-700 pr-4" id="val_wait1_area">-</td>
                            </tr>
                             <tr class="bg-yellow-50/30">
                                <td class="p-2.5 pl-4 text-yellow-800">二次候诊(C3)</td>
                                <td class="p-2.5 text-right text-yellow-600 font-bold" id="val_wait2_peak">0</td>
                                <td class="p-2.5 text-right font-mono font-bold text-yellow-700 pr-4" id="val_wait2_area">-</td>
                            </tr>
                            <tr>
                                <td class="p-2.5 pl-4">诊室(D)</td>
                                <td class="p-2.5 text-right font-medium" id="txt_doc_count">-</td>
                                <td class="p-2.5 text-right font-mono font-bold text-indigo-700 pr-4" id="val_doc_area">-</td>
                            </tr>
                            <tr>
                                <td class="p-2.5 pl-4">检查科室(G)</td>
                                <td class="p-2.5 text-right font-medium" id="txt_exam_count">-</td>
                                <td class="p-2.5 text-right font-mono font-bold text-indigo-700 pr-4" id="val_exam_area">-</td>
                            </tr>
                             <tr>
                                <td class="p-2.5 pl-4 text-gray-500">交通/大厅(35%)</td>
                                <td class="p-2.5 text-right text-gray-400 font-medium">est</td>
                                <td class="p-2.5 text-right font-mono font-bold text-gray-500 pr-4" id="val_circ_area">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Queue Chart -->
                <div class="h-32 bg-white/40 rounded-2xl p-3 border border-white/50 shadow-sm">
                    <canvas id="queueChart"></canvas>
                </div>
            </div>

             <!-- Collapsed -->
            <div class="hidden absolute inset-0 flex items-center justify-center collapsed-content opacity-0">
                <span class="collapsed-text font-black text-gray-400/50 text-xs">REPORT</span>
            </div>
        </div>

    </main>

<script>
// ================= CONFIGURATION =================
const CONFIG = {
    nodeRadius: 24,
    patientRadius: 3,
    walkSpeed: 60, // pixels per second (visual base)
    scale: 1,
    maxTime: 480 // minutes (8 hours)
};

// 拓扑结构 (Coordinates for visual layout)
const NODES = {
    A:  { x: 100, y: 150, label: '挂号 A', color: '#94a3b8', type: 'service' },
    B:  { x: 100, y: 350, label: '大厅 B', color: '#e2e8f0', type: 'transit' },
    C1: { x: 300, y: 350, label: '护士站 C1', color: '#f472b6', type: 'service' },
    C2: { x: 450, y: 350, label: '一级候诊 C2', color: '#fbbf24', type: 'queue' },
    C3: { x: 600, y: 350, label: '二候 C3', color: '#f59e0b', type: 'queue' },
    D:  { x: 750, y: 350, label: '诊室 D', color: '#34d399', type: 'service' },
    G:  { x: 750, y: 550, label: '检查 G', color: '#818cf8', type: 'service' },
    E:  { x: 950, y: 350, label: '药房 E', color: '#a78bfa', type: 'service' },
    F:  { x: 1100, y: 350, label: '离院 F', color: '#cbd5e1', type: 'sink' }
};

// Swimlanes for Graph
const LANES = ['A', 'C1', 'C2', 'C3', 'D', 'G', 'E'];
// Y-Axis mapping for interpolation in graph
const LANE_IDX = { A:0, B:0.5, C1:1, C2:2, C3:3, D:4, G:5, E:6, F:6.5 };

// ================= STATE & SIMULATION =================
let simState = {
    running: false,
    speed: 1,
    time: 0, // minutes
    patients: [],
    finishedPatients: [], // Archive for graph
    resources: {},
    heatmapData: {}, 
    distances: {}, // Stores user input distances
    stats: {
        finished: 0,
        peakWait: { C2: 0, C3: 0 },
        peakConcurrent: 0, // Max active patients at once
        history: { time: [], qC2: [], qC3: [] }
    }
};

// Camera State for Both Views
let cameraLayout = { x: 0, y: 0, scale: 1, isDragging: false, startX: 0, startY: 0 };
let cameraGraph = { x: 0, y: 0, scale: 1, isDragging: false, startX: 0, startY: 0 };

let chartInstance = null;
let lastTime = 0;
let animFrame;
let currentView = 'layout';

// ================= INITIALIZATION =================
function initSim() {
    // Read Inputs
    const hourlyFlow = parseInt(document.getElementById('hourlyFlow').value);
    
    // Read Distances (Default fallback if empty)
    simState.distances = {
        'A_B': parseInt(document.getElementById('d_A_B').value) || 15,
        'B_C1': parseInt(document.getElementById('d_B_C1').value) || 25,
        'C_D': parseInt(document.getElementById('d_C_D').value) || 10,
        'D_G': parseInt(document.getElementById('d_D_G').value) || 40,
        'D_E': parseInt(document.getElementById('d_D_E').value) || 35,
        'E_F': parseInt(document.getElementById('d_E_F').value) || 20
    };

    // Reset State
    simState.time = 0;
    simState.patients = [];
    simState.finishedPatients = [];
    simState.heatmapData = {};
    LANES.forEach(l => simState.heatmapData[l] = []);
    
    simState.stats = { finished: 0, peakWait: { C2:0, C3:0 }, peakConcurrent: 0, history: { time:[], qC2:[], qC3:[] } };
    
    // Initialize Resources
    const createRes = (id, capId, timeId) => ({
        capacity: parseInt(document.getElementById(capId).value),
        serviceTime: parseFloat(document.getElementById(timeId).value),
        queue: [],
        processing: [] 
    });

    simState.resources = {
        A: createRes('A', 'res_reg', 'time_reg'),
        C1: createRes('C1', 'res_nurse', 'time_nurse'),
        D: createRes('D', 'res_doc', 'time_doc'),
        G: createRes('G', 'res_exam', 'time_exam'),
        E: createRes('E', 'res_phar', 'time_phar'),
        C2: { capacity: 9999, queue: [], processing: [] }, 
        C3: { capacity: parseInt(document.getElementById('res_doc').value), queue: [], processing: [] } 
    };
    
    simState.arrivalRate = hourlyFlow / 60; // patients per min
    simState.examRate = parseInt(document.getElementById('examRate').value) / 100;

    updateReport();
}

function initChart() {
    const ctx = document.getElementById('queueChart').getContext('2d');
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                { label: '一级候诊', data: [], borderColor: '#fbbf24', borderWidth: 2, pointRadius: 0, tension: 0.4, fill: false },
                { label: '二候', data: [], borderColor: '#f59e0b', borderWidth: 2, pointRadius: 0, tension: 0.4, fill: false }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: { legend: { display: true, labels: { boxWidth: 8, font: {size: 9}, color: '#64748b' } } },
            scales: {
                x: { display: false },
                y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { color: '#94a3b8', font: {size:9} } }
            }
        }
    });
}

// ================= LOGIC CORE =================
class Patient {
    constructor(id) {
        this.id = id;
        this.x = NODES.A.x - 50;
        this.y = NODES.A.y;
        this.target = 'A';
        this.state = 'walking'; 
        this.needsExam = Math.random() < simState.examRate;
        this.hasDoneExam = false;
        
        this.trace = []; 
        this.graphColor = this.needsExam ? 'rgba(79, 70, 229, 0.4)' : 'rgba(37, 99, 235, 0.4)';
        
        // Stats
        this.totalWalkDist = 0;

        // Visual Movement
        this.startX = this.x;
        this.startY = this.y;
        this.destX = NODES.A.x;
        this.destY = NODES.A.y;
        this.progress = 0;
        this.startNode = null;
        
        this.jx = (Math.random() - 0.5) * 15;
        this.jy = (Math.random() - 0.5) * 15;
    }

    setTarget(nodeId) {
        // Calculate Distance Key
        let distKey = null;
        const from = this.target; // current target is actually the "from" node now
        const to = nodeId;

        // Match edges to config keys
        if ((from === 'A' && to === 'B') || (from === 'B' && to === 'A')) distKey = 'A_B';
        else if ((from === 'B' && to === 'C1') || (from === 'C1' && to === 'B')) distKey = 'B_C1';
        else if (from === 'C1' && to === 'C2') distKey = null; // negligible
        else if (from === 'C2' && to === 'C3') distKey = null; // negligible
        else if ((from === 'C3' && to === 'D') || (from === 'D' && to === 'C3')) distKey = 'C_D'; // Wait to Doc
        else if ((from === 'D' && to === 'G') || (from === 'G' && to === 'D')) distKey = 'D_G';
        else if ((from === 'D' && to === 'E') || (from === 'E' && to === 'D')) distKey = 'D_E';
        else if ((from === 'G' && to === 'C1')) distKey = 'B_C1'; // Approximation: Exam back to Nurse is similar to Hall->Nurse? Or assume Exam is far. Let's use B_C1 + A_B for worst case? Let's just assume 30m for internal return.
        else if (from === 'E' && to === 'F') distKey = 'E_F';

        let physDist = 0;
        if (distKey && simState.distances[distKey]) {
            physDist = simState.distances[distKey];
        } else if (from === 'G' && to === 'C1') {
            physDist = 30; // Hardcoded return path
        } else if (from === 'G' && to === 'A') {
            physDist = 50; // Hardcoded return path
        }

        // Update Total Stats
        this.totalWalkDist += physDist;

        // Calculate Logic Duration based on Physical Distance
        // Walking Speed 1.2 m/s = 72 m/min
        // duration (min) = dist (m) / 72
        // IF physDist is 0 (e.g. C1->C2), use a small default 0.1 min
        const durationMin = physDist > 0 ? (physDist / 72) : 0.1;
        
        // Convert logic duration (min) to simulation update steps
        // The update loop provides dt in minutes.
        // We use seconds for `this.duration` in the original code, but `update` takes dt in seconds.
        // So `duration` property should be in seconds.
        // duration (sec) = durationMin * 60
        this.duration = durationMin * 60;

        this.startNode = this.target; 
        this.target = nodeId;
        this.state = 'walking';
        this.startX = this.x;
        this.startY = this.y;
        this.destX = NODES[nodeId].x;
        this.destY = NODES[nodeId].y;
        this.progress = 0;
    }

    update(dt) { // dt in seconds
        const curY = this.calculateGraphY();
        if (this.trace.length === 0 || simState.time - this.trace[this.trace.length-1].t > 0.5) {
             this.trace.push({ t: simState.time, y: curY });
        }

        if (this.state === 'walking') {
            this.progress += dt / this.duration;
            if (this.progress >= 1) {
                this.arrive();
            } else {
                this.x = this.startX + (this.destX - this.startX) * this.progress;
                this.y = this.startY + (this.destY - this.startY) * this.progress;
            }
        }
    }
    
    calculateGraphY() {
        if (this.state === 'walking') {
            const y1 = LANE_IDX[this.startNode] !== undefined ? LANE_IDX[this.startNode] : 0;
            const y2 = LANE_IDX[this.target] !== undefined ? LANE_IDX[this.target] : 0;
            return y1 + (y2 - y1) * Math.min(1, this.progress);
        } else {
            return LANE_IDX[this.target] !== undefined ? LANE_IDX[this.target] : 0;
        }
    }

    arrive() {
        this.x = this.destX;
        this.y = this.destY;
        const res = simState.resources[this.target];
        
        if (this.target === 'F') {
            this.state = 'finished';
            this.trace.push({ t: simState.time, y: LANE_IDX.F });
            simState.finishedPatients.push(this);
            return;
        }

        if (this.target === 'B') {
            this.setTarget('C1');
            return;
        }

        if (this.target === 'C2') {
            simState.resources.C2.queue.push(this);
            this.state = 'waiting';
        } else if (this.target === 'C3') {
            simState.resources.C3.queue.push(this);
            this.state = 'waiting';
        } else {
            res.queue.push(this);
            this.state = 'waiting';
        }
    }
}

function updateSim(dt) { // dt in minutes
    if (simState.time < CONFIG.maxTime) {
        if (Math.random() < simState.arrivalRate * dt) {
            const p = new Patient(Date.now());
            p.setTarget('A');
            simState.patients.push(p);
        }
    }

    const processServer = (nodeId, nextNodeFn) => {
        const res = simState.resources[nodeId];
        while (res.processing.length < res.capacity && res.queue.length > 0) {
            const p = res.queue.shift();
            p.state = 'service';
            p.x = NODES[nodeId].x + (Math.random()-0.5)*20; 
            p.y = NODES[nodeId].y + (Math.random()-0.5)*20;
            res.processing.push({ p: p, t: res.serviceTime });
        }
        for (let i = res.processing.length - 1; i >= 0; i--) {
            const item = res.processing[i];
            item.t -= dt;
            if (item.t <= 0) {
                res.processing.splice(i, 1);
                const next = nextNodeFn(item.p);
                item.p.setTarget(next);
            }
        }
    };

    processServer('A', () => 'B');
    processServer('C1', () => 'C2');

    const c3Cap = simState.resources.D.capacity; 
    while (simState.resources.C3.queue.length < c3Cap && simState.resources.C2.queue.length > 0) {
        const p = simState.resources.C2.queue.shift();
        p.setTarget('C3');
    }

    const resDoc = simState.resources.D;
    while (resDoc.processing.length < resDoc.capacity && simState.resources.C3.queue.length > 0) {
         const p = simState.resources.C3.queue.shift();
         p.state = 'service';
         p.x = NODES.D.x + (Math.random()-0.5)*30;
         p.y = NODES.D.y + (Math.random()-0.5)*30;
         resDoc.processing.push({ p: p, t: resDoc.serviceTime });
    }
    
    for (let i = resDoc.processing.length - 1; i >= 0; i--) {
        const item = resDoc.processing[i];
        item.t -= dt;
        if (item.t <= 0) {
            resDoc.processing.splice(i, 1);
            if (item.p.needsExam && !item.p.hasDoneExam) {
                item.p.setTarget('G');
            } else {
                item.p.setTarget('E');
            }
        }
    }

    processServer('G', (p) => {
        p.hasDoneExam = true;
        return Math.random() > 0.1 ? 'C1' : 'A';
    });

    processServer('E', () => 'F');

    for (let i = simState.patients.length - 1; i >= 0; i--) {
        const p = simState.patients[i];
        if (p.state !== 'finished') {
            p.update(dt * 60);
        } else {
             simState.patients.splice(i, 1);
        }
    }

    // Stats
    const timeIdx = Math.floor(simState.time);
    LANES.forEach(l => {
        while(simState.heatmapData[l].length <= timeIdx) {
            const qLen = simState.resources[l].queue ? simState.resources[l].queue.length : 0;
            simState.heatmapData[l].push(qLen);
        }
    });

    simState.stats.peakWait.C2 = Math.max(simState.stats.peakWait.C2, simState.resources.C2.queue.length);
    simState.stats.peakWait.C3 = Math.max(simState.stats.peakWait.C3, simState.resources.C3.queue.length);
    
    // Calculate concurrent patients (Active + Waiting + Processing)
    // Simplified: Just `simState.patients.length` since finished are removed
    simState.stats.peakConcurrent = Math.max(simState.stats.peakConcurrent, simState.patients.length);

    if (simState.time % 5 < dt) {
        simState.stats.history.time.push(timeIdx);
        simState.stats.history.qC2.push(simState.resources.C2.queue.length);
        simState.stats.history.qC3.push(simState.resources.C3.queue.length);
        if(simState.stats.history.time.length > 30) {
            simState.stats.history.time.shift();
            simState.stats.history.qC2.shift();
            simState.stats.history.qC3.shift();
        }
        updateChart();
    }
}

// ... [Visualization Functions drawLayout, drawGraph, etc. remain unchanged] ...
const canvas = document.getElementById('simCanvas');
const ctx = canvas.getContext('2d');
const graphCanvas = document.getElementById('graphCanvas');
const graphCtx = graphCanvas.getContext('2d');

function resize() {
    canvas.width = document.getElementById('layoutWrapper').clientWidth;
    canvas.height = document.getElementById('layoutWrapper').clientHeight;
    graphCanvas.width = document.getElementById('graphWrapper').clientWidth;
    graphCanvas.height = document.getElementById('graphWrapper').clientHeight;
}
window.addEventListener('resize', resize);

function drawLayoutLegend() {
    const pX = 20, pY = canvas.height - 130;
    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
    ctx.beginPath();
    ctx.roundRect(pX - 10, pY - 10, 160, 120, 12);
    ctx.fill();
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.font = 'bold 10px Inter';
    ctx.textAlign = 'left';
    ctx.fillStyle = '#475569';
    ctx.fillText('图例 Legend', pX, pY + 5);
    const items = [
        { c: '#94a3b8', t: '服务节点 Service' },
        { c: '#fbbf24', t: '排队节点 Queue' },
        { c: '#e2e8f0', t: '交通 Transit' },
        { c: '#2563eb', t: '普通患者 Patient', type: 'circle' },
        { c: '#4f46e5', t: '检查患者 Exam' , type: 'circle' },
        { c: '#ea580c', t: '回流患者 Return' , type: 'circle' }
    ];
    items.forEach((item, i) => {
        const y = pY + 25 + i * 15;
        ctx.fillStyle = item.c;
        ctx.beginPath();
        if (item.type === 'circle') { ctx.arc(pX + 6, y - 3, 4, 0, Math.PI*2); } else { ctx.roundRect(pX, y - 7, 12, 8, 2); }
        ctx.fill();
        ctx.fillStyle = '#64748b';
        ctx.font = '10px Inter';
        ctx.fillText(item.t, pX + 20, y);
    });
}

function drawLayout() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(cameraLayout.x, cameraLayout.y);
    ctx.scale(cameraLayout.scale, cameraLayout.scale);
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(203, 213, 225, 0.8)';
    ctx.lineWidth = 3;
    ctx.lineCap = 'round';
    ctx.moveTo(NODES.A.x, NODES.A.y); ctx.lineTo(NODES.B.x, NODES.B.y);
    ctx.lineTo(NODES.C1.x, NODES.C1.y); ctx.lineTo(NODES.C2.x, NODES.C2.y);
    ctx.lineTo(NODES.C3.x, NODES.C3.y); ctx.lineTo(NODES.D.x, NODES.D.y);
    ctx.lineTo(NODES.E.x, NODES.E.y); ctx.lineTo(NODES.F.x, NODES.F.y);
    ctx.stroke();
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(199, 210, 254, 0.8)';
    ctx.setLineDash([5, 5]);
    ctx.moveTo(NODES.D.x, NODES.D.y); ctx.lineTo(NODES.G.x, NODES.G.y); 
    ctx.lineTo(NODES.C1.x, NODES.G.y); ctx.lineTo(NODES.C1.x, NODES.C1.y); 
    ctx.stroke();
    ctx.setLineDash([]);
    Object.keys(NODES).forEach(k => {
        const n = NODES[k];
        ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.beginPath(); ctx.arc(n.x, n.y + 4, CONFIG.nodeRadius, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = n.color; ctx.beginPath(); ctx.arc(n.x, n.y, CONFIG.nodeRadius, 0, Math.PI*2); ctx.fill();
        const grad = ctx.createLinearGradient(n.x - CONFIG.nodeRadius, n.y - CONFIG.nodeRadius, n.x + CONFIG.nodeRadius, n.y + CONFIG.nodeRadius);
        grad.addColorStop(0, 'rgba(255,255,255,0.7)'); grad.addColorStop(0.5, 'rgba(255,255,255,0)');
        ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(n.x, n.y, CONFIG.nodeRadius, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#334155'; ctx.font = 'bold 11px Inter'; ctx.textAlign = 'center'; ctx.fillText(n.label, n.x, n.y + CONFIG.nodeRadius + 14);
        let count = 0;
        if (simState.resources[k]) {
            const qL = simState.resources[k].queue ? simState.resources[k].queue.length : 0;
            const pL = simState.resources[k].processing ? simState.resources[k].processing.length : 0;
            count = qL + pL;
        }
        if (count > 0) {
            ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(n.x + 10, n.y - 10, 9, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'white'; ctx.font = 'bold 10px Inter'; ctx.fillText(count, n.x+10, n.y-6.5);
        }
    });
    simState.patients.forEach(p => {
        if (p.state === 'finished') return;
        const color = p.hasDoneExam ? '#ea580c' : (p.needsExam ? '#4f46e5' : '#2563eb');
        ctx.fillStyle = color; ctx.beginPath(); ctx.arc(p.x + p.jx, p.y + p.jy, CONFIG.patientRadius, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.6)'; ctx.beginPath(); ctx.arc(p.x + p.jx - 1, p.y + p.jy - 1, 1, 0, Math.PI*2); ctx.fill();
    });
    ctx.restore();
    drawLayoutLegend();
}

function drawGraphLegend() {
    const gCtx = graphCtx;
    const pX = 20, pY = graphCanvas.height - 100;
    gCtx.fillStyle = 'rgba(255, 255, 255, 0.7)'; gCtx.beginPath(); gCtx.roundRect(pX - 10, pY - 10, 160, 90, 12); gCtx.fill();
    gCtx.strokeStyle = 'rgba(255, 255, 255, 0.6)'; gCtx.lineWidth = 1; gCtx.stroke();
    gCtx.font = 'bold 10px Inter'; gCtx.textAlign = 'left'; gCtx.fillStyle = '#475569'; gCtx.fillText('拥堵热力 Heatmap', pX, pY + 5);
    const items = [ { c: '#bbf7d0', t: '通畅 < 50%' }, { c: '#fde047', t: '繁忙 > 50%' }, { c: '#fca5a5', t: '拥堵 > 100%' }, { c: '#2563eb', t: '患者轨迹 Trace', type: 'line' } ];
    items.forEach((item, i) => {
        const y = pY + 25 + i * 15;
        gCtx.fillStyle = item.c;
        if(item.type === 'line') { gCtx.strokeStyle = item.c; gCtx.lineWidth = 2; gCtx.beginPath(); gCtx.moveTo(pX, y - 3); gCtx.lineTo(pX + 12, y - 3); gCtx.stroke(); } 
        else { gCtx.roundRect(pX, y - 7, 12, 8, 2); gCtx.fill(); }
        gCtx.fillStyle = '#64748b'; gCtx.font = '10px Inter'; gCtx.fillText(item.t, pX + 20, y);
    });
}

function drawGraph() {
    const w = graphCanvas.width;
    const h = graphCanvas.height;
    graphCtx.clearRect(0,0,w,h);
    graphCtx.save();
    graphCtx.translate(cameraGraph.x, cameraGraph.y);
    graphCtx.scale(cameraGraph.scale, cameraGraph.scale);
    const rowH = h / LANES.length;
    const warnLimit = parseInt(document.getElementById('warn_thresh').value) || 10;
    const xScale = w / CONFIG.maxTime;
    LANES.forEach((k, i) => {
        const y = i * rowH;
        const history = simState.heatmapData[k];
        if (history && history.length > 0) {
            for (let t = 0; t < history.length; t++) {
                const qLen = history[t];
                let color = 'rgba(240, 253, 244, 0.8)';
                if (qLen > warnLimit) color = 'rgba(254, 202, 202, 0.8)';
                else if (qLen > warnLimit * 0.5) color = 'rgba(254, 240, 138, 0.8)';
                graphCtx.fillStyle = color;
                graphCtx.fillRect(t * xScale, y, Math.max(1, xScale) + 0.5, rowH);
            }
        }
        graphCtx.strokeStyle = 'rgba(200,200,200,0.3)'; graphCtx.lineWidth = 1;
        graphCtx.beginPath(); graphCtx.moveTo(-w, y + rowH); graphCtx.lineTo(w*2, y + rowH); graphCtx.stroke();
        graphCtx.fillStyle = '#475569'; graphCtx.font = 'bold 11px Inter'; graphCtx.fillText(NODES[k].label, 5, y + rowH/2);
    });
    const allPatients = [...simState.finishedPatients, ...simState.patients];
    graphCtx.lineWidth = 1;
    allPatients.forEach(p => {
        if(p.trace.length < 2) return;
        graphCtx.strokeStyle = p.graphColor;
        graphCtx.globalAlpha = 0.4;
        graphCtx.beginPath();
        const startX = p.trace[0].t * xScale;
        const startY = p.trace[0].y * rowH + rowH/2 + p.jy; 
        graphCtx.moveTo(startX, startY);
        for(let i=1; i<p.trace.length; i++) {
            const px = p.trace[i].t * xScale;
            const py = p.trace[i].y * rowH + rowH/2 + p.jy;
            graphCtx.lineTo(px, py);
        }
        graphCtx.stroke();
        graphCtx.globalAlpha = 1.0;
    });
    const cx = simState.time * xScale;
    graphCtx.strokeStyle = '#ef4444'; graphCtx.lineWidth = 2;
    graphCtx.beginPath(); graphCtx.moveTo(cx, 0); graphCtx.lineTo(cx, h); graphCtx.stroke();
    graphCtx.textAlign = 'center'; graphCtx.fillStyle = '#94a3b8';
    for (let hMark = 0; hMark <= 8; hMark++) {
        const mx = (hMark * 60) * xScale;
        graphCtx.fillText(hMark + "h", mx, h - 5);
        graphCtx.beginPath(); graphCtx.strokeStyle = 'rgba(0,0,0,0.1)'; graphCtx.moveTo(mx, 0); graphCtx.lineTo(mx, h); graphCtx.stroke();
    }
    graphCtx.restore();
    drawGraphLegend();
}

function loop() {
    if (simState.running) {
        const now = performance.now();
        const dtReal = (now - lastTime) / 1000; 
        lastTime = now;
        let multiplier = simState.speed;
        let subSteps = 1;
        if (multiplier > 50) { subSteps = 10; multiplier = multiplier / 10; }
        for (let i = 0; i < subSteps; i++) {
             const simDt = (dtReal * multiplier) / 60; 
             simState.time += simDt;
             updateSim(simDt);
             if (simState.time >= CONFIG.maxTime) { simState.running = false; break; }
        }
        document.getElementById('simTimeDisplay').innerText = 
            `${Math.floor(simState.time/60).toString().padStart(2,'0')}:${Math.floor(simState.time%60).toString().padStart(2,'0')}`;
        updateReport();
    }
    if (currentView === 'layout') drawLayout(); else drawGraph();
    animFrame = requestAnimationFrame(loop);
}

// ================= REPORTING =================
function updateReport() {
    const counts = {
        reg: parseInt(document.getElementById('res_reg').value),
        nurse: parseInt(document.getElementById('res_nurse').value),
        doc: parseInt(document.getElementById('res_doc').value),
        exam: parseInt(document.getElementById('res_exam').value)
    };
    const unitAreas = {
        doc: parseFloat(document.getElementById('area_doc_unit').value),
        exam: parseFloat(document.getElementById('area_exam_unit').value),
        nurse: parseFloat(document.getElementById('area_nurse').value),
        wait: parseFloat(document.getElementById('area_wait_unit').value)
    };

    const areaReg = counts.reg * 6; 
    const areaNurse = unitAreas.nurse;
    const areaDoc = counts.doc * unitAreas.doc;
    const areaExam = counts.exam * unitAreas.exam;
    
    const peak1 = simState.stats.peakWait.C2;
    const peak2 = simState.stats.peakWait.C3;
    const areaWait1 = Math.max(20, Math.ceil(peak1 * unitAreas.wait * 1.2)); 
    const areaWait2 = Math.max(10, Math.ceil(peak2 * unitAreas.wait * 1.5)); 
    
    const medTotal = areaReg + areaNurse + areaDoc + areaExam;
    const waitTotal = areaWait1 + areaWait2;
    const circTotal = Math.ceil((medTotal + waitTotal) * 0.35); 

    const totalArea = medTotal + waitTotal + circTotal;

    document.getElementById('total_area').innerText = totalArea;
    document.getElementById('txt_reg_count').innerText = counts.reg;
    document.getElementById('val_reg_area').innerText = areaReg;
    document.getElementById('val_nurse_area').innerText = areaNurse;
    document.getElementById('val_wait1_peak').innerText = peak1;
    document.getElementById('val_wait1_area').innerText = areaWait1;
    document.getElementById('val_wait2_peak').innerText = peak2;
    document.getElementById('val_wait2_area').innerText = areaWait2;
    document.getElementById('txt_doc_count').innerText = counts.doc;
    document.getElementById('val_doc_area').innerText = areaDoc;
    document.getElementById('txt_exam_count').innerText = counts.exam;
    document.getElementById('val_exam_area').innerText = areaExam;
    document.getElementById('val_circ_area').innerText = circTotal;

    document.getElementById('bar_med').style.width = (medTotal/totalArea*100) + '%';
    document.getElementById('bar_wait').style.width = (waitTotal/totalArea*100) + '%';
    document.getElementById('bar_circ').style.width = (circTotal/totalArea*100) + '%';

    // New Efficiency Metrics
    // Avg Walk Distance
    let totalDist = 0;
    let countFinished = simState.finishedPatients.length;
    simState.finishedPatients.forEach(p => totalDist += p.totalWalkDist);
    // Add current active patients distance to calculation? Usually stats report completed journeys.
    // Let's stick to finished for accuracy.
    const avgDist = countFinished > 0 ? Math.round(totalDist / countFinished) : 0;
    document.getElementById('val_avg_dist').innerText = avgDist;

    // Area Per Person (Concurrent)
    // Avoid division by zero
    const peakConcurrent = Math.max(1, simState.stats.peakConcurrent);
    const areaPerPerson = (totalArea / peakConcurrent).toFixed(1);
    document.getElementById('val_area_per_person').innerText = areaPerPerson;
}

function updateChart() {
    chartInstance.data.labels = simState.stats.history.time;
    chartInstance.data.datasets[0].data = simState.stats.history.qC2;
    chartInstance.data.datasets[1].data = simState.stats.history.qC3;
    chartInstance.update('none');
}

// ... [Controls toggle/changeSpeed/reset/camera/attach] ...
function toggleSimulation() {
    simState.running = !simState.running;
    lastTime = performance.now();
    if(simState.running) {
        document.getElementById('iconPlay').classList.add('hidden');
        document.getElementById('iconPause').classList.remove('hidden');
    } else {
        document.getElementById('iconPlay').classList.remove('hidden');
        document.getElementById('iconPause').classList.add('hidden');
    }
}

function changeSpeed(val) {
    simState.speed = val;
    [1, 10, 100].forEach(v => {
        document.getElementById('speed'+v).className = "px-3 py-1.5 text-[10px] font-semibold rounded-lg hover:bg-white/60 text-gray-600 transition-all";
    });
    document.getElementById('speed'+val).className = "px-3 py-1.5 text-[10px] font-bold rounded-lg bg-indigo-100/50 text-indigo-700 transition-all hover:bg-white/60";
}

function resetSimulation() {
    simState.running = false;
    initSim();
    drawLayout();
    document.getElementById('iconPlay').classList.remove('hidden');
    document.getElementById('iconPause').classList.add('hidden');
    document.getElementById('simTimeDisplay').innerText = "00:00";
}

function resetCamera(view) {
    // FIX: Mutate existing object instead of reassigning
    const target = view === 'layout' ? cameraLayout : cameraGraph;
    target.x = 0;
    target.y = 0;
    target.scale = 1;
    target.isDragging = false;
}

function switchView(v) {
    currentView = v;
    document.getElementById('viewLayout').className = v==='layout' ? 'absolute inset-0 flex flex-col h-full w-full' : 'hidden';
    document.getElementById('viewGraph').className = v==='graph' ? 'absolute inset-0 flex flex-col h-full w-full' : 'hidden';
    
    const btnLayout = document.getElementById('btnViewLayout');
    const btnGraph = document.getElementById('btnViewGraph');
    
    const activeClass = "glass-btn active-view-btn px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2";
    const inactiveClass = "glass-btn px-4 py-2 rounded-xl text-xs font-bold text-gray-600 flex items-center gap-2";

    if(v==='layout') {
        btnLayout.className = activeClass;
        btnGraph.className = inactiveClass;
        drawLayout();
    } else {
        btnGraph.className = activeClass;
        btnLayout.className = inactiveClass;
        drawGraph();
    }
}

function togglePanel(side) {
    const p = document.getElementById(side+'Panel');
    const content = p.querySelectorAll('.panel-content');
    const collapsed = p.querySelector('.collapsed-content');
    
    if(p.classList.contains('w-10')) {
        p.classList.remove('w-10');
        p.classList.add(side==='left'?'w-80':'w-80');
        content.forEach(el => el.classList.remove('hidden'));
        collapsed.classList.add('hidden');
        collapsed.classList.remove('opacity-100');
    } else {
        p.classList.remove(side==='left'?'w-80':'w-80');
        p.classList.add('w-10');
        content.forEach(el => el.classList.add('hidden'));
        collapsed.classList.remove('hidden');
        setTimeout(() => collapsed.classList.add('opacity-100'), 100);
    }
    setTimeout(resize, 450);
}

function attachCameraControl(elementId, cameraObj) {
    const el = document.getElementById(elementId);
    
    el.addEventListener('mousedown', e => {
        cameraObj.isDragging = true;
        cameraObj.startX = e.clientX - cameraObj.x;
        cameraObj.startY = e.clientY - cameraObj.y;
        el.style.cursor = 'grabbing';
    });
    
    window.addEventListener('mouseup', () => {
        cameraObj.isDragging = false;
        el.style.cursor = 'move';
    });
    
    window.addEventListener('mousemove', e => {
        if(cameraObj.isDragging) {
            cameraObj.x = e.clientX - cameraObj.startX;
            cameraObj.y = e.clientY - cameraObj.startY;
        }
    });

    el.addEventListener('wheel', e => {
        e.preventDefault();
        const zoomIntensity = 0.1;
        const delta = e.deltaY > 0 ? -zoomIntensity : zoomIntensity;
        const newScale = cameraObj.scale + delta;
        if(newScale > 0.2 && newScale < 5) {
            cameraObj.scale = newScale;
        }
    });
}

attachCameraControl('layoutWrapper', cameraLayout);
attachCameraControl('graphWrapper', cameraGraph);

initChart();
initSim();
resize();
loop();

</script>
</body>
</html>
